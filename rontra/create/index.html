<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RonTra â€” ì»¤ë®¤ë‹ˆí‹° ë§Œë“¤ê¸°</title>
  <link rel="stylesheet" href="../assets/css/style.css" />
</head>
<body>
  <header class="header">
    <div class="brand">RonTra</div>
    <nav class="nav" aria-label="ì£¼ ë©”ë‰´">
      <a href="../index.html">ì‹œì‘í•˜ê¸°</a>
      <a href="./" class="active">ì»¤ë®¤ë‹ˆí‹° ë§Œë“¤ê¸°</a>
      <a href="../settings/">ì„¤ì •</a>
    </nav>
    <div class="header-right">
      <button id="notifBtn" class="icon-btn" title="ì•Œë¦¼">ğŸ””</button>
      <button id="profileBtn" class="icon-btn" title="í”„ë¡œí•„">ğŸ‘¤</button>
      <button id="authBtn" class="btn">ë¡œê·¸ì¸</button>
    </div>
  </header>

  <main class="container">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <h2>ëª¨ë“  ì»¤ë®¤ë‹ˆí‹°</h2>
      <div>
        <button id="openCreate" class="btn">ì»¤ë®¤ë‹ˆí‹° ìƒì„±</button>
      </div>
    </div>

    <section class="community-grid" id="communityGrid">
      <!-- community cards -->
    </section>
  </main>

  <footer class="footer">
    <div class="inner">
      <div>
        <div class="logo">BANBLE LEON</div>
        <div class="small" style="margin-top:8px">
          <a class="small" href="#">ì´ìš©ì•½ê´€</a> Â· <a class="small" href="#">ë²•ì  ì±…ì„ ê³ ì§€</a> Â· <a class="small" href="#">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>
        </div>
      </div>
      <div style="text-align:right">
        <div class="small">BANBLE LEON TEAM Â© 2024. All rights reserved.</div>
      </div>
    </div>
  </footer>

  <!-- Fullscreen modal (not covering header/footer) -->
  <div id="createModal" class="fullscreen-modal" role="dialog" aria-modal="true">
    <h3>ìƒˆ ì»¤ë®¤ë‹ˆí‹° ë§Œë“¤ê¸°</h3>
    <div style="display:flex;gap:12px">
      <div style="flex:1">
        <label class="small">ë°°ë„ˆ ì—…ë¡œë“œ</label>
        <img id="bannerPreview" class="preview" alt="ë°°ë„ˆ ë¯¸ë¦¬ë³´ê¸°" />
        <input id="bannerFile" class="file-input" type="file" accept="image/*" />
        <div class="small">ê¶Œì¥ í¬ê¸°: 1200x360 (ë¹„ìœ¨ë§Œ ë§ì¶”ë©´ ë¨)</div>
      </div>
      <div style="flex:1">
        <label class="small">ì»¤ë®¤ë‹ˆí‹° ì´ë¦„</label>
        <input id="commName" class="input" placeholder="ì»¤ë®¤ë‹ˆí‹° ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" />
        <label class="small" style="margin-top:8px">ìµœëŒ€ ê°€ì…ì ìˆ˜</label>
        <input id="capacity" class="input" type="number" min="1" value="100" />
        <label class="small" style="margin-top:8px">ê°€ì… ì‹ ì²­ ê¸°ëŠ¥ ì‚¬ìš©</label>
        <div><input id="requiresApproval" type="checkbox" /> ê°€ì… ìš”ì²­ì„ ìˆ˜ë½ í›„ ìŠ¹ì¸</div>
        <label class="small" style="margin-top:8px">ê³µê°œ ì—¬ë¶€</label>
        <div><input id="isPublic" type="checkbox" checked /> ê³µê°œ ì»¤ë®¤ë‹ˆí‹°ë¡œ ì„¤ì •</div>
        <label class="small" style="margin-top:8px">ì„¤ëª…</label>
        <textarea id="description" class="input" rows="6" placeholder="ì»¤ë®¤ë‹ˆí‹° ì†Œê°œ"></textarea>

        <div style="margin-top:12px;display:flex;gap:8px">
          <button id="createBtn" class="btn">ìƒì„±</button>
          <button id="cancelCreate" class="btn">ì·¨ì†Œ</button>
        </div>
        <div id="createStatus" class="small" style="margin-top:8px"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { auth, db, storage } from '../assets/js/firebase-init.js';
    import { collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js';
    import { ref, uploadBytesResumable, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.4.0/firebase-storage.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js';

    const communityGrid = document.getElementById('communityGrid');
    const openCreate = document.getElementById('openCreate');
    const createModal = document.getElementById('createModal');
    const bannerFile = document.getElementById('bannerFile');
    const bannerPreview = document.getElementById('bannerPreview');
    const commName = document.getElementById('commName');
    const capacity = document.getElementById('capacity');
    const requiresApproval = document.getElementById('requiresApproval');
    const isPublic = document.getElementById('isPublic');
    const description = document.getElementById('description');
    const createBtn = document.getElementById('createBtn');
    const cancelCreate = document.getElementById('cancelCreate');
    const createStatus = document.getElementById('createStatus');

    let currentUser = null;
    onAuthStateChanged(auth, user => {
      currentUser = user;
      // show/hide create button depending on auth (optional)
      openCreate.disabled = !user;
      openCreate.title = user ? '' : 'ë¡œê·¸ì¸ í›„ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤';
    });

    openCreate.addEventListener('click', ()=> {
      createModal.classList.add('open');
      window.scrollTo({top:0,behavior:'smooth'});
    });
    cancelCreate.addEventListener('click', ()=> {
      createModal.classList.remove('open');
    });

    // preview banner
    bannerFile.addEventListener('change', ()=> {
      const f = bannerFile.files[0];
      if(!f) return;
      const url = URL.createObjectURL(f);
      bannerPreview.src = url;
    });

    // load communities
    const q = query(collection(db,'communities'), orderBy('createdAt','desc'));
    onSnapshot(q, snap => {
      communityGrid.innerHTML = '';
      snap.forEach(doc => {
        const d = doc.data();
        const card = document.createElement('div');
        card.className = 'community-card-large';
        card.innerHTML = `
          <div style="height:140px;overflow:hidden;background:#051018">
            <img src="${d.bannerURL || ''}" alt="" class="banner-preview" />
          </div>
          <div class="meta">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div style="font-weight:800">${d.name}</div>
                <div class="small">${d.memberCount || 0}ëª… Â· ${d.isPublic ? 'ê³µê°œ' : 'ë¹„ê³µê°œ'}</div>
              </div>
              <div>
                <button class="btn" data-id="${doc.id}">ì…ì¥</button>
              </div>
            </div>
            <div class="small" style="margin-top:8px">${d.description || ''}</div>
          </div>
        `;
        card.querySelector('button.btn').addEventListener('click', ()=>{
          window.location.href = '../community.html?id=' + doc.id;
        });
        communityGrid.appendChild(card);
      });
    });

    // create community: upload banner then add doc
    createBtn.addEventListener('click', async ()=>{
      if(!currentUser){ alert('ë¡œê·¸ì¸ í›„ ìƒì„±í•˜ì„¸ìš”'); return; }
      const name = commName.value.trim();
      if(!name){ alert('ì»¤ë®¤ë‹ˆí‹° ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”'); return; }
      createBtn.disabled = true;
      createStatus.textContent = 'ì—…ë¡œë“œ ë° ìƒì„± ì¤‘...';
      try {
        let bannerURL = '';
        const f = bannerFile.files[0];
        if(f){
          const path = 'community_banners/' + Date.now() + '_' + f.name;
          const sRef = ref(storage, path);
          const task = uploadBytesResumable(sRef, f);
          await new Promise((res, rej) => {
            task.on('state_changed', null, err=> rej(err), ()=> res());
          });
          bannerURL = await getDownloadURL(sRef);
        }
        const docRef = await addDoc(collection(db,'communities'), {
          name,
          bannerURL,
          capacity: Number(capacity.value) || 0,
          requiresApproval: !!requiresApproval.checked,
          isPublic: !!isPublic.checked,
          description: description.value || '',
          ownerId: currentUser.uid,
          memberCount: 1,
          createdAt: serverTimestamp()
        });
        createStatus.textContent = 'ìƒì„± ì™„ë£Œ. ì»¤ë®¤ë‹ˆí‹°ë¡œ ì´ë™í•©ë‹ˆë‹¤...';
        setTimeout(()=> {
          window.location.href = '../community.html?id=' + docRef.id;
        }, 900);
      } catch (err) {
        console.error(err);
        createStatus.textContent = 'ì˜¤ë¥˜: ' + err.message;
      } finally {
        createBtn.disabled = false;
      }
    });

    // Simple auth UI from header for quick usage (duplicate from index)
    const authBtn = document.getElementById('authBtn');
    authBtn.addEventListener('click', ()=> {
      // open a small auth form by redirecting to root where modal exists
      window.location.href = '../index.html';
    });

  </script>
</body>
</html>
