<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RonTra â€” ì„¤ì •</title>
  <link rel="stylesheet" href="../assets/css/style.css" />
</head>
<body>
  <header class="header">
    <div class="brand">RonTra</div>
    <nav class="nav" aria-label="ì£¼ ë©”ë‰´">
      <a href="../index.html">ì‹œì‘í•˜ê¸°</a>
      <a href="../create/">ì»¤ë®¤ë‹ˆí‹° ë§Œë“¤ê¸°</a>
      <a href="./" class="active">ì„¤ì •</a>
    </nav>
    <div class="header-right">
      <button id="notifBtn" class="icon-btn" title="ì•Œë¦¼">ğŸ””</button>
      <button id="profileBtn" class="icon-btn" title="í”„ë¡œí•„">ğŸ‘¤</button>
      <button id="authBtn" class="btn">ë¡œê·¸ì¸</button>
    </div>
  </header>

  <main class="container">
    <div class="card">
      <h3>ë‚´ í”„ë¡œí•„ í¸ì§‘</h3>
      <div style="display:flex;gap:12px;align-items:center">
        <img id="avatarPreview" src="" alt="avatar" style="width:96px;height:96px;border-radius:12px;object-fit:cover;background:#081018" />
        <div style="flex:1">
          <input id="displayName" class="input" placeholder="í‘œì‹œ ì´ë¦„" />
          <div style="margin-top:8px">
            <input id="avatarFile" type="file" accept="image/*" />
            <button id="uploadAvatar" class="btn">ì—…ë¡œë“œ</button>
          </div>
        </div>
      </div>
      <div style="margin-top:12px">
        <button id="saveProfile" class="btn">ì €ì¥</button>
        <button id="signOut" class="btn">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>

    <div class="card">
      <h3>ë‚´ê°€ ë§Œë“  ì»¤ë®¤ë‹ˆí‹°</h3>
      <div id="ownedList"></div>
    </div>
  </main>

  <footer class="footer">
    <div class="inner">
      <div>
        <div class="logo">BANBLE LEON</div>
        <div class="small" style="margin-top:8px">
          <a class="small" href="#">ì´ìš©ì•½ê´€</a> Â· <a class="small" href="#">ë²•ì  ì±…ì„ ê³ ì§€</a> Â· <a class="small" href="#">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>
        </div>
      </div>
      <div style="text-align:right">
        <div class="small">BANBLE LEON TEAM Â© 2024. All rights reserved.</div>
      </div>
    </div>
  </footer>

  <script type="module">
    import { auth, db, storage } from '../assets/js/firebase-init.js';
    import { ref, uploadBytesResumable, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.4.0/firebase-storage.js';
    import { updateProfile, onAuthStateChanged, signOut as fbSignOut } from 'https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js';
    import { collection, query, where, onSnapshot, orderBy, doc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js';

    const avatarPreview = document.getElementById('avatarPreview');
    const avatarFile = document.getElementById('avatarFile');
    const uploadAvatar = document.getElementById('uploadAvatar');
    const displayName = document.getElementById('displayName');
    const saveProfile = document.getElementById('saveProfile');
    const signOutBtn = document.getElementById('signOut');
    const ownedList = document.getElementById('ownedList');

    let currentUser = null;
    onAuthStateChanged(auth, user => {
      currentUser = user;
      if(user){
        displayName.value = user.displayName || '';
        avatarPreview.src = user.photoURL || '';
        // load owned communities
        const q = query(collection(db,'communities'), where('ownerId','==', user.uid), orderBy('createdAt','desc'));
        onSnapshot(q, snap => {
          ownedList.innerHTML = '';
          snap.forEach(docSnap => {
            const d = docSnap.data();
            const el = document.createElement('div');
            el.className = 'list-item';
            el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
              <div><strong>${d.name}</strong><div class="small">${d.memberCount || 0}ëª…</div></div>
              <div>
                <button class="btn" data-id="${docSnap.id}">ê´€ë¦¬</button>
                <button class="btn" data-delete="${docSnap.id}">ì‚­ì œ</button>
              </div>
            </div>`;
            el.querySelector('button[data-id]').addEventListener('click', ()=>{
              window.location.href = '../community.html?id=' + docSnap.id;
            });
            el.querySelector('button[data-delete]').addEventListener('click', async ()=>{
              if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë³µêµ¬ ë¶ˆê°€)')) return;
              try {
                await deleteDoc(doc(db,'communities', docSnap.id));
                alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
              } catch (err) { alert('ì‚­ì œ ì˜¤ë¥˜: ' + err.message); }
            });
            ownedList.appendChild(el);
          });
        });
      } else {
        displayName.value = '';
        avatarPreview.src = '';
        ownedList.innerHTML = '<div class="small">ë¡œê·¸ì¸ í›„ ë‚´ ì»¤ë®¤ë‹ˆí‹°ë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>';
      }
    });

    avatarFile.addEventListener('change', ()=> {
      const f = avatarFile.files[0];
      if(f) avatarPreview.src = URL.createObjectURL(f);
    });

    uploadAvatar.addEventListener('click', async ()=>{
      if(!currentUser){ alert('ë¡œê·¸ì¸ í›„ ì‚¬ìš©í•˜ì„¸ìš”'); return; }
      const f = avatarFile.files[0];
      if(!f){ alert('ì—…ë¡œë“œí•  ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”'); return; }
      const path = 'avatars/' + currentUser.uid + '_' + Date.now() + '_' + f.name;
      const sRef = ref(storage, path);
      const task = uploadBytesResumable(sRef, f);
      try {
        await new Promise((res, rej) => task.on('state_changed', null, err=> rej(err), ()=> res()));
        const url = await getDownloadURL(sRef);
        await updateProfile(currentUser, { photoURL: url });
        alert('ì•„ë°”íƒ€ ì—…ë¡œë“œ ë° í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
      } catch (err) {
        alert('ì—…ë¡œë“œ ì˜¤ë¥˜: ' + err.message);
      }
    });

    saveProfile.addEventListener('click', async ()=> {
      if(!currentUser){ alert('ë¡œê·¸ì¸ í›„ ì‚¬ìš©í•˜ì„¸ìš”'); return; }
      try {
        await updateProfile(currentUser, { displayName: displayName.value || null });
        alert('í”„ë¡œí•„ ì €ì¥ ì™„ë£Œ');
      } catch (err) {
        alert('ì €ì¥ ì˜¤ë¥˜: ' + err.message);
      }
    });

    signOutBtn.addEventListener('click', async ()=> {
      await fbSignOut(auth);
      window.location.href = '../index.html';
    });

    // header auth shortcut
    const authBtn = document.getElementById('authBtn');
    authBtn.addEventListener('click', ()=> {
      window.location.href = '../index.html';
    });

  </script>
</body>
</html>
