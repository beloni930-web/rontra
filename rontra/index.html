<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RonTra — 메인</title>
  <link rel="stylesheet" href="./assets/css/style.css" />
</head>
<body>
  <header class="header">
    <div class="brand">RonTra</div>
    <nav class="nav" aria-label="주 메뉴">
      <a href="../index.html" class="active">시작하기</a>
      <a href="./create/">커뮤니티 만들기</a>
      <a href="./settings/">설정</a>
    </nav>
    <div class="header-right">
      <button id="notifBtn" class="icon-btn" title="알림">🔔</button>
      <button id="profileBtn" class="icon-btn" title="프로필">👤</button>
      <button id="authBtn" class="btn">로그인</button>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <!-- Carousel -->
      <div id="carousel" class="carousel">
        <!-- slides appended by JS -->
        <div class="dots" id="carouselDots"></div>
      </div>
    </section>

    <section class="grid-3">
      <div>
        <div class="card">
          <h3>최신 생성 커뮤니티</h3>
          <div id="communitiesList"></div>
        </div>

        <div class="card">
          <h3>최신 게시물 (공개)</h3>
          <div id="postsList"></div>
        </div>
      </div>

      <div class="card right-col">
        <h3>공지사항</h3>
        <div id="announcementsList"></div>
      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="inner">
      <div>
        <div class="logo">BANBLE LEON</div>
        <div class="small" style="margin-top:8px">
          <a class="small" href="#">이용약관</a> · <a class="small" href="#">법적 책임 고지</a> · <a class="small" href="#">개인정보처리방침</a>
        </div>
      </div>
      <div style="text-align:right">
        <div class="small">BANBLE LEON TEAM © 2024. All rights reserved.</div>
      </div>
    </div>
  </footer>

  <!-- auth modal (simple) -->
  <div id="authModal" class="card" style="position:fixed;right:20px;bottom:140px;display:none;width:320px;z-index:80">
    <h4>로그인 / 회원가입</h4>
    <input id="email" class="input" placeholder="이메일" type="email" />
    <input id="password" class="input" placeholder="비밀번호" type="password" />
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="btnSignUp" class="btn">회원가입</button>
      <button id="btnSignIn" class="btn">로그인</button>
    </div>
    <div style="margin-top:8px">
      <button id="btnGoogle" class="btn">구글 계정으로 로그인</button>
    </div>
  </div>

  <script type="module">
    import { auth, db } from './assets/js/firebase-init.js';
    import { collection, query, orderBy, limit, onSnapshot, where } from 'https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js';
    import { onAuthStateChanged, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInWithPopup } from 'https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js';
    import { googleProvider } from './assets/js/firebase-init.js';

    // Simple carousel data (can be replaced by Firestore 'slides' collection)
    const carouselEl = document.getElementById('carousel');
    const dotsEl = document.getElementById('carouselDots');

    // placeholder slides; user can later replace via Firestore
    let slides = [
      {id:1, img:'', title:'이벤트: RonTra 런칭!', link:'#', bg:true},
      {id:2, img:'', title:'커뮤니티 만들기 이벤트', link:'#', bg:true},
      {id:3, img:'', title:'새로운 기능 업데이트', link:'#', bg:true}
    ];

    function renderCarousel(){
      carouselEl.innerHTML = '';
      slides.forEach((s, idx) => {
        const slide = document.createElement('div');
        slide.className = 'slide' + (idx===0 ? ' active' : '');
        // if img provided use <img> else gradient placeholder
        if(s.img){
          const a = document.createElement('a');
          a.href = s.link || '#';
          a.target = '_blank';
          const img = document.createElement('img');
          img.src = s.img;
          a.appendChild(img);
          slide.appendChild(a);
        } else {
          const box = document.createElement('div');
          box.style.cssText = 'width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,0.85);font-size:20px;background:linear-gradient(90deg,#05252a,#0a1220);';
          box.innerText = s.title || '슬라이드';
          slide.appendChild(box);
        }
        const overlay = document.createElement('div');
        overlay.className = 'overlay';
        slide.appendChild(overlay);
        carouselEl.appendChild(slide);
      });
      // dots
      dotsEl.innerHTML = '';
      slides.forEach((_, i) => {
        const d = document.createElement('div');
        d.className = 'dot' + (i===0 ? ' active' : '');
        d.dataset.index = i;
        d.addEventListener('click', ()=> goto(i));
        dotsEl.appendChild(d);
      });
    }

    let current = 0;
    let timer = null;
    function goto(i){
      const slidesNodes = document.querySelectorAll('.slide');
      slidesNodes.forEach((n, idx) => n.classList.toggle('active', idx===i));
      document.querySelectorAll('.dot').forEach((d, idx) => d.classList.toggle('active', idx===i));
      current = i;
    }
    function nextSlide(){
      const n = (current + 1) % slides.length;
      goto(n);
    }
    function startAuto(){ timer = setInterval(nextSlide, 5000); }
    function stopAuto(){ if(timer) clearInterval(timer); timer = null; }

    renderCarousel();
    startAuto();

    // Firestore lists (realtime)
    const communitiesList = document.getElementById('communitiesList');
    const postsList = document.getElementById('postsList');
    const announcementsList = document.getElementById('announcementsList');

    // communities
    const commQ = query(collection(db,'communities'), orderBy('createdAt','desc'), limit(6));
    onSnapshot(commQ, snapshot => {
      communitiesList.innerHTML = '';
      snapshot.forEach(doc => {
        const d = doc.data();
        const el = document.createElement('div');
        el.className = 'list-item community-card';
        el.innerHTML = `
          <img src="${d.bannerURL || 'data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' width=200 height=120><rect width=200 height=120 fill=%23081212/></svg>'}" alt="banner" />
          <div style="flex:1">
            <div style="font-weight:700">${d.name || 'Unnamed'}</div>
            <div class="small">${d.memberCount || 0}명 · ${d.isPublic ? '공개' : '비공개'}</div>
          </div>
        `;
        el.addEventListener('click', ()=> {
          window.location.href = './community.html?id=' + doc.id;
        });
        communitiesList.appendChild(el);
      });
    });

    // posts (public only)
    const postsQ = query(collection(db,'posts'), where('isPublic','==', true), orderBy('createdAt','desc'), limit(6));
    onSnapshot(postsQ, snap => {
      postsList.innerHTML = '';
      snap.forEach(doc => {
        const d = doc.data();
        const el = document.createElement('div');
        el.className = 'list-item';
        const time = d.createdAt && d.createdAt.toDate ? d.createdAt.toDate().toLocaleString() : '';
        el.innerHTML = `<div style="font-weight:700">${d.title || '제목 없음'}</div><div class="small">${d.preview || ''}</div><div class="small" style="margin-top:6px">${time}</div>`;
        postsList.appendChild(el);
      });
    });

    // announcements
    const annQ = query(collection(db,'announcements'), orderBy('createdAt','desc'), limit(6));
    onSnapshot(annQ, snap => {
      announcementsList.innerHTML = '';
      snap.forEach(doc => {
        const d = doc.data();
        const el = document.createElement('div');
        el.className = 'list-item';
        el.innerHTML = `<div style="font-weight:700">${d.title}</div><div class="small">${d.summary || ''}</div>`;
        announcementsList.appendChild(el);
      });
    });

    // simple auth UI toggle + handlers
    const authBtn = document.getElementById('authBtn');
    const authModal = document.getElementById('authModal');
    const btnSignUp = document.getElementById('btnSignUp');
    const btnSignIn = document.getElementById('btnSignIn');
    const btnGoogle = document.getElementById('btnGoogle');
    const emailInput = document.getElementById('email');
    const pwInput = document.getElementById('password');

    authBtn.addEventListener('click', ()=> {
      authModal.style.display = authModal.style.display === 'block' ? 'none' : 'block';
    });

    btnSignUp.addEventListener('click', async ()=>{
      const email = emailInput.value.trim();
      const pw = pwInput.value;
      if(!email || !pw){ alert('이메일/비밀번호를 입력하세요'); return; }
      try {
        await createUserWithEmailAndPassword(auth, email, pw);
        alert('회원가입 되었습니다');
        authModal.style.display = 'none';
      } catch (err) {
        alert('회원가입 오류: ' + err.message);
      }
    });

    btnSignIn.addEventListener('click', async ()=>{
      const email = emailInput.value.trim();
      const pw = pwInput.value;
      if(!email || !pw){ alert('이메일/비밀번호를 입력하세요'); return; }
      try {
        await signInWithEmailAndPassword(auth, email, pw);
        authModal.style.display = 'none';
      } catch (err) {
        alert('로그인 오류: ' + err.message);
      }
    });

    btnGoogle.addEventListener('click', async ()=>{
      try {
        await signInWithPopup(auth, googleProvider);
        authModal.style.display = 'none';
      } catch (err) {
        alert('구글 로그인 오류: ' + err.message);
      }
    });

    // update auth button based on state
    onAuthStateChanged(auth, user => {
      if(user){
        authBtn.textContent = user.displayName || user.email || '로그아웃';
        authBtn.onclick = async () => { await signOut(auth); };
      } else {
        authBtn.textContent = '로그인';
        authBtn.onclick = ()=> { authModal.style.display = 'block'; };
      }
    });

  </script>
</body>
</html>
